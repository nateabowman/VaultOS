name: Build VaultOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build-packages:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Fedora Build Environment
      run: |
        sudo dnf install -y mock rpm-build createrepo_c
        
    - name: Build RPM Packages
      run: |
        cd scripts
        chmod +x build-packages.sh
        ./build-packages.sh
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: rpm-packages
        path: ~/rpmbuild/RPMS/**/*.rpm
        retention-days: 30

  build-iso:
    runs-on: ubuntu-latest
    needs: build-packages
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Build Environment
      run: |
        sudo dnf install -y lorax livemedia-creator
        
    - name: Build ISO
      run: |
        cd scripts
        chmod +x build-iso.sh
        ./build-iso.sh
        
    - name: Upload ISO
      uses: actions/upload-artifact@v3
      with:
        name: vaultos-iso
        path: build/**/*.iso
        retention-days: 30

  test-vm:
    runs-on: ubuntu-latest
    needs: build-iso
    steps:
    - uses: actions/checkout@v3
    - uses: actions/download-artifact@v3
      with:
        name: vaultos-iso
        
    - name: Setup QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86
        
    - name: Test ISO in VM
      run: |
        # Basic smoke test - boot ISO
        timeout 60 qemu-system-x86_64 \
          -cdrom vaultos-*.iso \
          -m 2048 \
          -display none \
          -no-reboot \
          || true

  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Run unit tests
      run: |
        cd tests/unit
        chmod +x run-tests.sh
        ./run-tests.sh || true
    
    - name: Run integration tests
      run: |
        cd tests/integration
        chmod +x test-wm-integration.sh
        ./test-wm-integration.sh || true
    
    - name: Run security tests
      run: |
        cd tests/security
        chmod +x test-security.sh
        ./test-security.sh || true
    
    - name: Run all tests
      run: |
        cd tests
        chmod +x run-all-tests.sh
        ./run-all-tests.sh || true

  performance-benchmark:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Build window manager
      run: |
        cd src/wm/vaultwm
        make clean
        make
    
    - name: Measure build time
      run: |
        echo "Build time measurement would go here"
        # In a full implementation, this would measure:
        # - Compilation time
        # - Binary size
        # - Memory usage

